<!DOCTYPE html><html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Ferragosto Pizza Contest ‚Äì Vota la tua preferita!</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <style>
:root{--primary-color:#FF4757;--secondary-color:#00D2FF;--accent-color:#FFD93D;--tertiary-color:#2ED8B6;--coral-color:#FF6B9D;--sunset-orange:#FF6348;--ocean-blue:#0984e3;--dark-bg:#1e3c72;--card-bg:rgba(30,60,114,.15);--text-light:#fff;--text-muted:#e6f3ff;--gradient-primary:linear-gradient(135deg,#FF4757 0%,#FFD93D 100%);--gradient-secondary:linear-gradient(135deg,#00D2FF 0%,#2ED8B6 100%);--gradient-sunset:linear-gradient(135deg,#FF6348 0%,#FFD93D 100%);--gradient-hero:linear-gradient(135deg,rgba(30,60,114,.8) 0%,rgba(0,210,255,.3) 100%);--shadow-primary:0 15px 40px rgba(255,71,87,.4);--shadow-secondary:0 15px 40px rgba(0,210,255,.3);--shadow-card:0 20px 60px rgba(0,0,0,.2);--border-radius:20px;--transition:all .4s cubic-bezier(.4,0,.2,1)}*{margin:0;padding:0;box-sizing:border-box}html{scroll-behavior:smooth}
body{font-family:Poppins,sans-serif;background:radial-gradient(circle at 20% 80%,rgba(255,217,61,.3) 0,transparent 50%),radial-gradient(circle at 80% 20%,rgba(255,107,157,.3) 0,transparent 50%),radial-gradient(circle at 40% 40%,rgba(0,210,255,.2) 0,transparent 50%),linear-gradient(135deg,#1e3c72 0,#2a5298 25%,#1e3c72 50%,#2a5298 75%,#1e3c72 100%);background-size:400% 400%;animation:gradientShift 15s ease infinite;color:var(--text-light);line-height:1.6;overflow-x:hidden;position:relative}
@keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}
.navbar{background:transparent!important;transition:var(--transition);padding:1.2rem 0;z-index:1000;border-bottom:1px solid rgba(255,255,255,.1)}.navbar.scrolled{background:rgba(30,60,114,.95)!important;box-shadow:0 8px 32px rgba(0,210,255,.3);border-bottom:1px solid rgba(0,210,255,.3)}.navbar-brand{font-weight:700;font-size:1.6rem;background:var(--gradient-sunset);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-decoration:none;transition:var(--transition)}.navbar-brand:hover{transform:scale(1.05);filter:drop-shadow(0 0 10px rgba(255,71,87,.5))}.navbar-brand i{margin-right:.5rem;color:var(--secondary-color);animation:bounce 3s infinite}
.navbar-nav .nav-link{color:var(--text-light)!important;font-weight:500;margin:0 .5rem;transition:all .5s cubic-bezier(.25,.46,.45,.94);position:relative;padding:.5rem 1rem!important;border-radius:25px;overflow:hidden}
.navbar-nav .nav-link::before{content:"";position:absolute;top:0;left:0;width:0;height:100%;background:var(--gradient-secondary);border-radius:25px;transition:all .6s cubic-bezier(.25,.46,.45,.94);z-index:-1;opacity:0}
.navbar-nav .nav-link:hover::before{width:100%;opacity:1}
.navbar-nav .nav-link.btn{background:var(--gradient-sunset)!important;border-radius:30px!important;padding:.8rem 2rem!important;margin-left:1rem!important;box-shadow:var(--shadow-primary);position:relative;overflow:hidden}
.hero{min-height:100vh;background:var(--gradient-hero);display:flex;align-items:center;position:relative;overflow:hidden}
.hero::after{content:"";position:absolute;inset:0;background-image:url('./img/hero.jpg');opacity:.08;background-size:cover;background-position:center;mix-blend:screen}
.hero-content{position:relative;z-index:2;text-align:center}
.hero-title{font-size:3.2rem;font-weight:700;margin-bottom:1rem;background:var(--gradient-sunset);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 8px 30px rgba(255,71,87,.5)}
.hero-subtitle{font-size:1.6rem;font-weight:300;background:var(--gradient-secondary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:1rem}
.hero-description{font-size:1.1rem;color:var(--text-light);max-width:820px;margin:0 auto 1.2rem}
.countdown{display:flex;justify-content:center;gap:.6rem;flex-wrap:wrap}
.countdown .cd{background:rgba(255,255,255,.12);padding:.5rem .8rem;border:1px solid rgba(255,255,255,.25);border-radius:12px;min-width:72px}
.btn-hero{background:var(--gradient-sunset);border:none;border-radius:50px;padding:1rem 2rem;font-size:1.1rem;font-weight:700;color:#fff;text-decoration:none;box-shadow:var(--shadow-primary);transition:var(--transition);display:inline-block;letter-spacing:.5px}
.btn-hero:hover{transform:translateY(-3px)}
section{padding:5rem 0;position:relative}.section-title{text-align:center;font-size:2.2rem;font-weight:700;margin-bottom:2rem;background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}
.dark-card{background:var(--card-bg);border-radius:var(--border-radius);padding:1.5rem;border:1px solid rgba(255,255,255,.1);box-shadow:var(--shadow-card);transition:var(--transition)}
.pizza-card{height:100%;display:flex;flex-direction:column;transform:perspective(900px) translateZ(0);transition:transform .25s ease}
.pizza-card:hover{transform:perspective(900px) rotateX(1.5deg) rotateY(-1.5deg)}
.pizza-img{border-radius:16px;overflow:hidden;height:200px;margin-bottom:1rem}
.pizza-img img{width:100%;height:100%;object-fit:cover;transition:transform .6s ease;filter:saturate(1.05)}
.pizza-card:hover .pizza-img img{transform:scale(1.06)}
.vote-btn{background:var(--gradient-primary);border:none;border-radius:12px;padding:.65rem 1.1rem;color:#fff;font-weight:600;box-shadow:var(--shadow-primary);transition:var(--transition)}
.vote-btn.active{outline:2px solid #FFD93D}
.pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.75rem;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
.badge-mine{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#FFD93D,#FF6B9D);color:#111;padding:.25rem .5rem;border-radius:999px;font-weight:700;box-shadow:0 6px 22px rgba(0,0,0,.25)}
.gallery-img{border-radius:16px;overflow:hidden}
/* Pizzaioli */
.chef-card{text-align:center;transition:var(--transition)}
.chef-card:hover{transform:translateY(-6px)}
.chef-img{width:140px;height:140px;border-radius:50%;border:3px solid var(--primary-color);overflow:hidden;margin:0 auto 1rem}
.chef-img img{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}
.chef-card:hover .chef-img img{transform:scale(1.06) rotate(1.5deg)}
#resultsCanvas{width:100%;max-width:900px;height:360px}
.footer{background:linear-gradient(135deg,rgba(30,60,114,.9) 0,rgba(0,0,0,.9) 100%);padding:3rem 0 2rem;border-top:2px solid rgba(255,217,61,.3)}
.section-title code{color:#FFD93D}
@keyframes bounce{0%,20%,50%,80%,100%{transform:translateY(0)}40%{transform:translateY(-10px)}60%{transform:translateY(-5px)}}
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-fire"></i>Pizza Contest</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07" aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon" style="filter:invert(1)"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsExample07">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#vota">Vota</a></li>
          <li class="nav-item"><a class="nav-link" href="#classifica">Classifica</a></li>
          <li class="nav-item"><a class="nav-link" href="#gallery">Gallery</a></li>
        </ul>
      </div>
    </div>
  </nav>  <header class="hero">
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">Ferragosto Pizza Contest 2025</h1>
        <p class="hero-subtitle">Vota la pizza pi√π buona üî•üçï</p>
        <p class="hero-description">Voto unico per utente (anonimo), classifica live multi‚Äëdispositivo. Puoi <strong>cambiare voto</strong> fino alla scadenza.</p>
        <div class="countdown mb-3" id="countdown"></div>
        <div>
          <span class="hero-date"><i class="bi bi-calendar-event"></i> 15 Agosto 2025</span>
          <span class="hero-location"><i class="bi bi-geo-alt"></i> Italia</span>
        </div>
        <a href="#vota" class="btn-hero">Vai al voto</a>
      </div>
    </div>
  </header>  <!-- PIZZAIOLI -->  <section id="pizzaioli">
    <div class="container">
      <h2 class="section-title">I pizzaioli</h2>
      <div class="row g-4">
        <div class="col-12 col-md-6 col-lg-3">
          <div class="dark-card chef-card h-100">
            <div class="chef-img"><img src="./img/pizzaioli/giuseppe.jpg" alt="Mario Rossi" loading="lazy"></div>
            <h5 class="mb-1">Giuseppe</h5>
            <small class="text-info">Impasti a lunga maturazione</small>
            <p class="mt-2 text-light">Appassionato di biga e prefermenti, ama la margherita tradizionale con pomodoro San Marzano.</p>
          </div>
        </div>
        <div class="col-12 col-md-6 col-lg-3">
          <div class="dark-card chef-card h-100">
            <div class="chef-img"><img src="./img/pizzaioli/AlessioL.jpeg" alt="Giulia Bianchi" loading="lazy"></div>
            <h5 class="mb-1">Alessio</h5>
            <small class="text-info">Creativit√† & topping di stagione</small>
            <p class="mt-2 text-light">Predilige ingredienti locali e verdure grigliate per pizze leggere ma saporite.</p>
          </div>
        </div>
      </div>
    </div>
  </section>  <section id="vota">
    <div class="container">
      <h2 class="section-title">I concorrenti</h2>
      <div id="cards" class="row g-4"></div>
      <div class="text-center mt-4">
        <span class="pill" id="votesInfo">Voti totali: 0</span>
        <span class="pill ms-2" id="deviceInfo">Stato: non autenticato</span>
      </div>
      <div id="adminTools" class="dark-card mt-5 d-none">
        <h5 class="mb-3"><i class="bi bi-shield-lock"></i> Pannello Organizzatore</h5>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-secondary" id="btnClearLocal">Pulisci cache locale</button>
          <button class="btn btn-sm btn-outline-warning" id="btnTestWrite">Test write</button>
          <button class="btn btn-sm btn-success" id="btnExportCsv">Scarica CSV</button>
          <button class="btn btn-sm btn-outline-light" id="btnExportJson">Scarica JSON</button>
        </div>
      </div>
    </div>
  </section>  <section id="classifica">
    <div class="container">
      <h2 class="section-title">Classifica live</h2>
      <div class="dark-card d-flex flex-column align-items-center">
        <canvas id="resultsCanvas"></canvas>
      </div>
    </div>
  </section>  <section id="gallery">
    <div class="container">
      <h2 class="section-title">Gallery</h2>
      <div id="pizzaCarousel" class="carousel slide dark-card" data-bs-ride="carousel">
        <div class="carousel-inner">
          <div class="carousel-item active">
            <img class="d-block w-100 gallery-img" src="./img/gallery1.jpg" alt="Pizza 1" loading="lazy">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100 gallery-img" src="./img/gallery2.jpg" alt="Pizza 2" loading="lazy">
          </div>
          <div class="carousel-item">
            <img class="d-block w-100 gallery-img" src="./img/gallery3.jpg" alt="Pizza 3" loading="lazy">
          </div>
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#pizzaCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon" aria-hidden="true"></span><span class="visually-hidden">Precedente</span></button>
        <button class="carousel-control-next" type="button" data-bs-target="#pizzaCarousel" data-bs-slide="next"><span class="carousel-control-next-icon" aria-hidden="true"></span><span class="visually-hidden">Successiva</span></button>
      </div>
    </div>
  </section>  <footer class="footer">
    <div class="container text-center">
      <p class="mb-1">Made with üçï e tanto amore. Ferragosto 2025.</p>
    </div>
  </footer>  <div id="debugStatus" class="alert alert-danger d-none" role="alert" style="position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:2000;max-width:92vw"></div>  <script type="module">
  // === DATA (immagini dalla repo ./img/<id>.jpg) ===
  const ENTRIES = [
    { id: 'margherita', name: 'Margherita Classica', author: 'Team Napoli', img: './img/margherita.jpg', desc: 'Pomodoro San Marzano, fiordilatte, basilico.' },
    { id: 'diavola', name: 'Diavola', author: 'Team Piccante', img: './img/diavola.jpg', desc: 'Salame piccante, peperoncino, mozzarella.' },
    { id: 'bufalina', name: 'Bufalina DOP', author: 'Caseificio Lovers', img: './img/bufalina.jpg', desc: 'Mozzarella di bufala, piennolo, basilico.' },
    { id: 'ortolana', name: 'Ortolana', author: 'Green Squad', img: './img/ortolana.jpg', desc: 'Verdure grigliate, leggera ma con carattere.' }
  ];

  // === Firebase SDK (modular) ===
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
  import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
  import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';
  import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

  const firebaseConfig = { apiKey:"AIzaSyCuPSHBGhypBqboK54Dpi0UlFipBmzbaP0", authDomain:"pizza-contest.firebaseapp.com", databaseURL:"https://pizza-contest-default-rtdb.europe-west1.firebasedatabase.app", projectId:"pizza-contest", storageBucket:"pizza-contest.firebasestorage.app", messagingSenderId:"76144886476", appId:"1:76144886476:web:fd87ceafa108fe4e6cf869", measurementId:"G-Q9FMW6YVBF" };

  function showStatus(msg, type='danger'){
    const el = document.getElementById('debugStatus');
    el.className = `alert alert-${type}`;
    el.textContent = msg;
    el.classList.remove('d-none');
    clearTimeout(window.__stsTo);
    window.__stsTo = setTimeout(()=> el.classList.add('d-none'), 6000);
  }

  // Confetti multicolore
  function confetti(){
    const layer = document.createElement('div');
    layer.style.position='fixed'; layer.style.inset='0'; layer.style.pointerEvents='none'; layer.style.zIndex='3000';
    document.body.appendChild(layer);
    const c = document.createElement('canvas'); layer.appendChild(c);
    const ctx = c.getContext('2d'); const dpr = window.devicePixelRatio||1; const parts = [];
    function resize(){ c.width=innerWidth*dpr; c.height=innerHeight*dpr; }
    resize();
    const N = 160;
    for(let i=0;i<N;i++) parts.push({ x: Math.random()*innerWidth, y: -20-Math.random()*200, vy: 2+Math.random()*4, vx: -1+Math.random()*2, w: 6+Math.random()*8, h: 8+Math.random()*12, rot: Math.random()*6, hue: Math.floor(Math.random()*360)});
    let t=0; (function loop(){ t++; ctx.clearRect(0,0,c.width,c.height); ctx.save(); ctx.scale(dpr,dpr);
      for(const p of parts){ p.y+=p.vy; p.x+=p.vx; p.rot+=0.12; ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle = `hsl(${p.hue}, 90%, 60%)`; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.setTransform(1,0,0,1,0,0); }
      ctx.restore(); if(t<260) requestAnimationFrame(loop); else document.body.removeChild(layer);
    })();
    window.addEventListener('resize', resize, {once:true});
  }

  // Init Firebase
  let app, analytics;
  try { app = initializeApp(firebaseConfig); try { analytics = getAnalytics(app); } catch {} } catch(e){ console.error('Firebase init error', e); showStatus('Errore init Firebase: ' + (e?.message||e)); }
  const auth = getAuth(app);
  const db = getFirestore(app);

  const CONTEST_ID = 'ferragosto2025';
  const votesCol = collection(db, `contests/${CONTEST_ID}/votes`);

  // Stato
  let currentUser = null;
  let votesCache = [];
  let myVote = null;
  let votingClosed = false;

  // Auth anonima
  signInAnonymously(auth).catch(e=>{ console.error('Auth error', e); showStatus('Auth anonima fallita: ' + (e?.message||e)); });
  onAuthStateChanged(auth, async (user) => {
    currentUser = user;
    document.getElementById('deviceInfo').textContent = user ? `Utente: ${user.uid.slice(0,8)}‚Ä¶` : 'Stato: non autenticato';
    await fetchMyVote();
    initAdmin();
    subscribeVotes();
    renderAll();
  });

  async function fetchMyVote(){
    if(!currentUser) return;
    const snap = await getDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`));
    myVote = snap.exists()? (snap.data().entryId || null) : null;
  }

  // Voto (con cambio) blocco se scaduto
  async function vote(entryId){
    if (votingClosed) { showStatus('‚õî Votazioni chiuse.', 'warning'); return; }
    if(!currentUser){ showStatus('Auth in corso, riprova‚Ä¶','warning'); return; }
    const changing = myVote && myVote !== entryId;
    try{
      await setDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`), { entryId, ts: serverTimestamp(), ua: navigator.userAgent }, { merge: true });
      myVote = entryId;
      renderCards();
      confetti();
      showStatus(changing ? '‚úÖ Voto aggiornato!' : '‚úÖ Voto registrato!', 'success');
    }catch(e){
      console.error('Write error', e);
      if(String(e).includes('Missing or insufficient permissions')) showStatus('Regole Firestore: abilita UPDATE sul proprio doc.', 'warning');
      else showStatus('Scrittura voto fallita: ' + (e?.message||e));
    }
  }

  // Live subscribe
  function subscribeVotes(){
    onSnapshot(votesCol, (snap) => {
      votesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderResults();
      renderMeta();
    }, (e)=>{ console.error(e); showStatus('Errore lettura live: ' + (e?.message||e)); });
  }

  // Tally
  function tallyCounts(){
    const counts = Object.fromEntries(ENTRIES.map(e=>[e.id,0]));
    for(const v of votesCache){ if(v.entryId && counts[v.entryId] !== undefined) counts[v.entryId]++; }
    return counts;
  }
  function rankingData(){
    const counts = tallyCounts();
    const data = ENTRIES.map(e => ({...e, votes: counts[e.id]||0}));
    data.sort((a,b)=> b.votes - a.votes || a.name.localeCompare(b.name));
    return data;
  }

// RENDER
function renderCards(){
    const wrap = document.getElementById('cards');
    const counts = tallyCounts();
    wrap.innerHTML='';
    ENTRIES.forEach(entry => {
      const col = document.createElement('div');
      col.className = 'col-12 col-sm-6 col-lg-3 position-relative';
      const isMine = myVote === entry.id;
      const btnLabel = votingClosed ? '<i class="bi bi-lock"></i> Voto chiuso' : (isMine?'<i class="bi bi-arrow-repeat"></i> Cambia voto':'<i class="bi bi-hand-thumbs-up"></i> Vota');
      const btnDisabledAttr = votingClosed ? 'disabled' : '';
      col.innerHTML = `
        <div class="dark-card pizza-card h-100">
          <div class="pizza-img"><img src="${entry.img}" alt="${entry.name}" loading="lazy"></div>
          ${isMine ? '<div class="badge-mine"><i class="bi bi-heart-fill"></i> Il tuo voto</div>' : ''}
          <h5 class="mb-1">${entry.name}</h5>
          <small class="text-info">${entry.author}</small>
          <p class="mt-2 mb-3 text-light">${entry.desc}</p>
          <div class="d-flex align-items-center justify-content-between mt-auto">
            <button class="vote-btn ${isMine ? 'active' : ''}" data-id="${entry.id}" ${btnDisabledAttr}>${btnLabel}</button>
            <span class="pill"><i class="bi bi-people"></i> <span>${counts[entry.id]||0}</span></span>
          </div>
        </div>`;
      wrap.appendChild(col);
    });
    wrap.querySelectorAll('.vote-btn').forEach(btn => btn.addEventListener('click', () => vote(btn.getAttribute('data-id'))));
  }

  function renderChart(data){
    const canvas = document.getElementById('resultsCanvas');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');
    const dpr = window.devicePixelRatio || 1;
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    canvas.width = width * dpr; canvas.height = height * dpr;
    ctx.setTransform(dpr,0,0,dpr,0,0);
    ctx.clearRect(0,0,width,height);
    const m = {l: 120, r: 24, t: 22, b: 40};
    const gap = 12;
    const dataLen = Math.max(1, data.length);
    const barH = Math.max(24, Math.min(48, (height - m.t - m.b - gap*(dataLen-1)) / dataLen));
    const maxV = Math.max(1, ...data.map(d => d.votes));
    const x = v => m.l + (v / maxV) * (width - m.l - m.r);
    ctx.font = '14px Poppins, sans-serif'; ctx.textBaseline = 'middle';
    data.forEach((d,i)=>{
      const y = m.t + i * (barH + gap);
      ctx.fillStyle = '#e6f3ff'; ctx.fillText(d.name, 12, y + barH/2);
      ctx.fillStyle = 'rgba(255,255,255,.12)'; ctx.fillRect(m.l, y, width - m.l - m.r, barH);
      const grad = ctx.createLinearGradient(m.l, y, x(d.votes), y);
      grad.addColorStop(0,'#00D2FF'); grad.addColorStop(0.5,'#2ED8B6'); grad.addColorStop(1,'#FFD93D');
      ctx.fillStyle = grad; ctx.fillRect(m.l, y, Math.max(2, x(d.votes)-m.l), barH);
      ctx.fillStyle = '#fff'; ctx.font = 'bold 14px Poppins, sans-serif'; ctx.fillText(String(d.votes), x(d.votes)+8, y + barH/2);
    });
  }

  function renderResults(){
    renderCards();
    const data = rankingData();
    renderChart(data);
  }

  function renderMeta(){
    const total = votesCache.length;
    document.getElementById('votesInfo').textContent = `Voti totali: ${total}`;
  }

  function renderAll(){
    renderCards();
    renderMeta();
    renderChart(rankingData());
    window.addEventListener('resize', () => renderChart(rankingData()));
  }

  // Admin
  function initAdmin(){
    const params = new URLSearchParams(location.search);
    const isAdmin = params.get('admin') === '1';
    const box = document.getElementById('adminTools');
    if(isAdmin) box.classList.remove('d-none');
    const clearBtn = document.getElementById('btnClearLocal');
    if (clearBtn) clearBtn.addEventListener('click', () => { ['pizzaContest_votes_v1','pizzaContest_device_voted_v1'].forEach(k=> localStorage.removeItem(k)); showStatus('Cache locale (vecchia versione) pulita. Ricarica la pagina.', 'success'); });
    const testBtn = document.getElementById('btnTestWrite');
    if(testBtn) testBtn.addEventListener('click', async ()=>{
      if(!currentUser){ showStatus('Auth non pronta, riprova‚Ä¶', 'warning'); return; }
      try{ await setDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`), { entryId: 'TEST', ts: serverTimestamp(), ua: 'admin-test' }, { merge: true }); showStatus('‚úÖ Test write OK. Controlla Firestore.', 'success'); }
      catch(e){ console.error(e); showStatus('‚ùå Test write fallita: ' + (e?.message||e)); }
    });
    const exCsv = document.getElementById('btnExportCsv');
    if(exCsv) exCsv.addEventListener('click', async ()=> exportVotes('csv'));
    const exJson = document.getElementById('btnExportJson');
    if(exJson) exJson.addEventListener('click', async ()=> exportVotes('json'));
  }

  async function exportVotes(kind='csv'){
    const rows = votesCache.map(v => [v.id, v.entryId || '', (v.ts && v.ts.toDate ? v.ts.toDate().toISOString() : ''), v.ua || '']);
    if(kind==='json'){
      const blob = new Blob([JSON.stringify(rows.map(r=>({uid:r[0], entryId:r[1], ts:r[2], ua:r[3]})), null, 2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pizza_votes.json'; a.click();
    } else {
      const csv = [['uid','entryId','timestamp','ua'], ...rows].map(r=>r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(',')).join('');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pizza_votes.csv'; a.click();
    }
  }

  // Navbar effetto
  window.addEventListener('scroll', () => document.querySelector('.navbar').classList.toggle('scrolled', window.scrollY > 10));

  // COUNTDOWN (blocco voto allo scadere) ‚Äî mezzanotte locale
  const target = new Date('2025-08-15T00:00:00+02:00').getTime();
  function format2(n){return String(n).padStart(2,'0')}
  function tick(){
    const now = Date.now();
    const d = target - now;
    if (d <= 0) {
      if (!votingClosed) { votingClosed = true; renderCards(); showStatus('‚õî Votazioni chiuse.', 'warning'); }
      const zero = '<div class="cd"><strong>00</strong><div>giorni</div></div><div class="cd"><strong>00</strong><div>ore</div></div><div class="cd"><strong>00</strong><div>min</div></div><div class="cd"><strong>00</strong><div>sec</div></div>';
      document.getElementById('countdown').innerHTML = zero;
      return;
    }
    const s = Math.floor(d/1000);
    const days = Math.floor(s/86400);
    const hrs = Math.floor((s%86400)/3600);
    const mins = Math.floor((s%3600)/60);
    const secs = s%60;
    document.getElementById('countdown').innerHTML = 
      `<div class="cd"><strong>${days}</strong><div>giorni</div></div>`+
      `<div class="cd"><strong>${format2(hrs)}</strong><div>ore</div></div>`+
      `<div class="cd"><strong>${format2(mins)}</strong><div>min</div></div>`+
      `<div class="cd"><strong>${format2(secs)}</strong><div>sec</div></div>`;
  }
  setInterval(tick, 1000); tick();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
