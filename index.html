<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Ferragosto Pizza Contest ‚Äì Vota la tua preferita!</title>

  <!-- Fonts & UI -->
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">

  <style>
    :root{
      --primary-color:#FF4757;
      --secondary-color:#00D2FF;
      --accent-color:#FFD93D;
      --tertiary-color:#2ED8B6;
      --sunset-orange:#FF6348;
      --card-bg:rgba(30,60,114,.15);
      --text-light:#fff;
      --text-muted:#e6f3ff;
      --gradient-primary:linear-gradient(135deg,#FF4757 0%,#FFD93D 100%);
      --gradient-secondary:linear-gradient(135deg,#00D2FF 0%,#2ED8B6 100%);
      --gradient-sunset:linear-gradient(135deg,#FF6348 0%,#FFD93D 100%);
      --gradient-hero:linear-gradient(135deg,rgba(30,60,114,.8) 0%,rgba(0,210,255,.3) 100%);
      --shadow-primary:0 15px 40px rgba(255,71,87,.4);
      --shadow-card:0 20px 60px rgba(0,0,0,.2);
      --border-radius:20px;
      --transition:all .4s cubic-bezier(.4,0,.2,1);
    }

    *{margin:0;padding:0;box-sizing:border-box}
    html{scroll-behavior:smooth}

    body{
      font-family:Poppins,sans-serif;
      background:
        radial-gradient(circle at 20% 80%,rgba(255,217,61,.3) 0%,transparent 50%),
        radial-gradient(circle at 80% 20%,rgba(255,107,157,.3) 0%,transparent 50%),
        radial-gradient(circle at 40% 40%,rgba(0,210,255,.2) 0%,transparent 50%),
        linear-gradient(135deg,#1e3c72 0,#2a5298 25%,#1e3c72 50%,#2a5298 75%,#1e3c72 100%);
      background-size:400% 400%;
      animation:gradientShift 15s ease infinite;
      color:var(--text-light);
      line-height:1.6;
      overflow-x:hidden;
      position:relative;
    }
    @keyframes gradientShift{0%{background-position:0 50%}50%{background-position:100% 50%}100%{background-position:0 50%}}

    /* Navbar */
    .navbar{
      background:transparent!important;
      transition:var(--transition);
      padding:1.2rem 0;
      z-index:1000;
      border-bottom:1px solid rgba(255,255,255,.1)
    }
    .navbar.scrolled{
      background:rgba(30,60,114,.95)!important;
      box-shadow:0 8px 32px rgba(0,210,255,.3);
      border-bottom:1px solid rgba(0,210,255,.3)
    }
    .navbar-brand{
      font-weight:700;font-size:1.6rem;
      background:var(--gradient-sunset);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      background-clip:text;
      text-decoration:none;
      transition:var(--transition)
    }
    .navbar-brand i{margin-right:.5rem;color:var(--secondary-color)}

    .navbar-nav .nav-link{
      color:var(--text-light)!important;font-weight:500;margin:0 .5rem;
      position:relative;padding:.5rem 1rem!important;border-radius:25px;overflow:hidden
    }
    .navbar-nav .nav-link::before{
      content:"";position:absolute;top:0;left:0;width:0;height:100%;
      background:var(--gradient-secondary);border-radius:25px;transition:all .6s;z-index:-1;opacity:0
    }
    .navbar-nav .nav-link:hover::before{width:100%;opacity:1}

    /* Hero */
    .hero{min-height:100vh;background:var(--gradient-hero);display:flex;align-items:center;position:relative;overflow:hidden}
    .hero::after{content:"";position:absolute;inset:0;background-image:url('./img/hero.jpg');opacity:.08;background-size:cover;background-position:center;mix-blend:screen}
    .hero-content{text-align:center;position:relative;z-index:2}
    .hero-title{font-size:3.2rem;font-weight:700;margin-bottom:1rem;background:var(--gradient-sunset);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;text-shadow:0 8px 30px rgba(255,71,87,.5)}
    .hero-subtitle{font-size:1.6rem;font-weight:300;background:var(--gradient-secondary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;margin-bottom:1rem}
    .hero-description{font-size:1.1rem;max-width:820px;margin:0 auto 1.2rem}
    .countdown{display:flex;justify-content:center;gap:.6rem;flex-wrap:wrap}
    .countdown .cd{background:rgba(255,255,255,.12);padding:.5rem .8rem;border:1px solid rgba(255,255,255,.25);border-radius:12px;min-width:72px}

    .btn-hero{
      background:var(--gradient-sunset);border:none;border-radius:50px;padding:1rem 2rem;
      font-size:1.1rem;font-weight:700;color:#fff;text-decoration:none;box-shadow:var(--shadow-primary);
      transition:var(--transition);display:inline-block;letter-spacing:.5px
    }
    .btn-hero:hover{transform:translateY(-3px)}

    /* Sections */
    section{padding:5rem 0;position:relative}
    .section-title{text-align:center;font-size:2.2rem;font-weight:700;margin-bottom:2rem;
      background:var(--gradient-primary);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text}

    .dark-card{background:var(--card-bg);border-radius:var(--border-radius);padding:1.5rem;border:1px solid rgba(255,255,255,.1);box-shadow:var(--shadow-card);transition:var(--transition)}

    /* Cards */
    .pizza-card{height:100%;display:flex;flex-direction:column}
    .pizza-img{border-radius:16px;overflow:hidden;height:200px;margin-bottom:1rem}
    .pizza-img img{width:100%;height:100%;object-fit:cover;transition:transform .6s ease;filter:saturate(1.05)}
    .pizza-card:hover .pizza-img img{transform:scale(1.06)}

    .vote-btn{border:none;border-radius:12px;padding:.65rem 1.1rem;color:#fff;font-weight:600;transition:var(--transition)}
    .vote-btn.active{outline:2px solid #FFD93D}
    .vote-c1{background:linear-gradient(135deg,#00D2FF 0%,#2ED8B6 100%);box-shadow:0 10px 30px rgba(0,210,255,.25)}
    .vote-c2{background:linear-gradient(135deg,#FF6B9D 0%,#FFD93D 100%);box-shadow:0 10px 30px rgba(255,107,157,.25)}

    .pill{display:inline-block;padding:.25rem .6rem;border-radius:999px;font-size:.75rem;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25)}
    .badge-mine{position:absolute;top:12px;left:12px;background:linear-gradient(135deg,#FFD93D,#FF6B9D);color:#111;padding:.25rem .5rem;border-radius:999px;font-weight:700;box-shadow:0 6px 22px rgba(0,0,0,.25)}

    /* Pizzaioli */
    .chef-card{text-align:center;transition:var(--transition)}
    .chef-card:hover{transform:translateY(-6px)}
    .chef-img{width:140px;height:140px;border-radius:50%;border:3px solid var(--primary-color);overflow:hidden;margin:0 auto 1rem}
    .chef-img img{width:100%;height:100%;object-fit:cover;transition:transform .5s ease}
    .chef-card:hover .chef-img img{transform:scale(1.06) rotate(1.5deg)}

    /* Chart */
    #resultsCanvas{width:100%;max-width:900px;height:260px}

    /* Footer */
    .footer{background:linear-gradient(135deg,rgba(30,60,114,.9) 0,rgba(0,0,0,.9) 100%);padding:3rem 0 2rem;border-top:2px solid rgba(255,217,61,.3)}
    .section-title code{color:#FFD93D}

    /* Nascondi riquadri extra */
    #votesInfo,#deviceInfo{display:none!important}
  </style>
</head>
<body>
  <!-- NAVBAR -->
  <nav class="navbar navbar-expand-lg fixed-top">
    <div class="container">
      <a class="navbar-brand" href="#"><i class="bi bi-fire"></i>Pizza Contest</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarsExample07" aria-controls="navbarsExample07" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon" style="filter:invert(1)"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarsExample07">
        <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link" href="#vota">Vota</a></li>
          <li class="nav-item"><a class="nav-link" href="#classifica">Classifica</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <!-- HERO -->
  <header class="hero">
    <div class="container">
      <div class="hero-content">
        <h1 class="hero-title">Ferragosto Pizza Contest 2025</h1>
        <p class="hero-subtitle">Vota la tua pizza preferita üî•üçï</p>
        <p class="hero-description">
          Ogni pizza ha due pulsanti: <strong>Giuseppe</strong> e <strong>Alessio</strong>.
          Puoi cambiare voto fino alla scadenza.
        </p>
        <div class="countdown mb-3" id="countdown"></div>
        <div class="mb-3">
          <span class="hero-date"><i class="bi bi-calendar-event"></i> 15 Agosto 2025</span>
          <span class="hero-location"><i class="bi bi-geo-alt"></i> Italia, Villa Mezzina</span>
        </div>
        <a href="#vota" class="btn-hero">Vai al voto</a>
      </div>
    </div>
  </header>

  <!-- PIZZAIOLI -->
  <section id="pizzaioli">
    <div class="container">
      <h2 class="section-title">I pizzaioli</h2>
      <div class="row g-4">
        <div class="col-12 col-md-6">
          <div class="dark-card chef-card h-100">
            <div class="chef-img"><img src="./img/pizzaioli/giuseppe.jpg" alt="Giuseppe" loading="lazy"></div>
            <h5 class="mb-1">Giuseppe</h5>
            <small class="text-info">Impasti a lunga maturazione</small>
            <p class="mt-2 text-light">Appassionato di prefermenti e cotture rapide, equilibrio tra scioglievolezza e croccantezza.</p>
          </div>
        </div>
        <div class="col-12 col-md-6">
          <div class="dark-card chef-card h-100">
            <div class="chef-img"><img src="./img/pizzaioli/AlessioL.jpeg" alt="Alessio" loading="lazy"></div>
            <h5 class="mb-1">Alessio</h5>
            <small class="text-info">Creativit√† & topping di stagione</small>
            <p class="mt-2 text-light">Sperimenta farine e idratazioni spinte, combinando ingredienti di stagione.</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- VOTA -->
  <section id="vota">
    <div class="container">
      <h2 class="section-title">I concorrenti</h2>
      <div id="cards" class="row g-4"></div>

      <!-- Restano nel DOM (nascosti via CSS) -->
      <div class="text-center mt-4">
        <span class="pill" id="votesInfo">Voti totali: 0</span>
        <span class="pill ms-2" id="deviceInfo">Stato: non autenticato</span>
      </div>

      <!-- Admin tools -->
      <div id="adminTools" class="dark-card mt-5 d-none">
        <h5 class="mb-3"><i class="bi bi-shield-lock"></i> Pannello Organizzatore</h5>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-secondary" id="btnClearLocal">Pulisci cache locale</button>
          <button class="btn btn-sm btn-outline-warning" id="btnTestWrite">Test write</button>
          <button class="btn btn-sm btn-success" id="btnExportCsv">Scarica CSV</button>
          <button class="btn btn-sm btn-outline-light" id="btnExportJson">Scarica JSON</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CLASSIFICA -->
  <section id="classifica">
    <div class="container">
      <h2 class="section-title">Classifica pizzaioli</h2>
      <div class="dark-card d-flex flex-column align-items-center">
        <canvas id="resultsCanvas"></canvas>
      </div>
    </div>
  </section>

  <!-- FOOTER -->
  <footer class="footer">
    <div class="container text-center">
      <p class="mb-1">Made with üçï e tanto amore. Ferragosto 2025.</p>
    </div>
  </footer>

  <!-- DEBUG -->
  <div id="debugStatus" class="alert alert-danger d-none" role="alert" style="position:fixed;left:50%;transform:translateX(-50%);bottom:16px;z-index:2000;max-width:92vw"></div>

  <!-- APP -->
  <script type="module">
    /* =======================
       Config & Dati
    ======================= */
    const ENTRIES = [
      { id:'margherita', name:'Margherita Classica', img:'./img/margherita.jpg', desc:'', c1:'Giuseppe', c2:'Alessio' },
      { id:'diavola', name:'Diavola', img:'./img/diavola.jpg', desc:'', c1:'Giuseppe', c2:'Alessio' },
      { id:'patapizza', name:'Patapizza', img:'./img/patapizza.jpg', desc:'', c1:'Giuseppe', c2:'Alessio' },
      { id:'capricciosa', name:'Capricciosa', img:'./img/capricciosa.jpg', desc:'', c1:'Giuseppe', c2:'Alessio' }
    ];

    // Firebase SDK
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { getAnalytics } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-analytics.js';
    import { getFirestore, collection, doc, setDoc, getDoc, onSnapshot, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const firebaseConfig = {
      apiKey:"AIzaSyCuPSHBGhypBqboK54Dpi0UlFipBmzbaP0",
      authDomain:"pizza-contest.firebaseapp.com",
      databaseURL:"https://pizza-contest-default-rtdb.europe-west1.firebasedatabase.app",
      projectId:"pizza-contest",
      storageBucket:"pizza-contest.firebasestorage.app",
      messagingSenderId:"76144886476",
      appId:"1:76144886476:web:fd87ceafa108fe4e6cf869",
      measurementId:"G-Q9FMW6YVBF"
    };

    /* =======================
       Utils UI
    ======================= */
    function showStatus(msg, type='danger'){
      const el = document.getElementById('debugStatus');
      el.className = `alert alert-${type}`;
      el.textContent = msg;
      el.classList.remove('d-none');
      clearTimeout(window.__stsTo);
      window.__stsTo = setTimeout(()=> el.classList.add('d-none'), 5000);
    }

    function confetti(){
      const layer = document.createElement('div');
      layer.style.position='fixed'; layer.style.inset='0'; layer.style.pointerEvents='none'; layer.style.zIndex='3000';
      document.body.appendChild(layer);
      const c = document.createElement('canvas'); layer.appendChild(c);
      const ctx = c.getContext('2d'); const dpr = window.devicePixelRatio||1; const parts = [];
      function resize(){ c.width=innerWidth*dpr; c.height=innerHeight*dpr; } resize();
      const N = 160;
      for(let i=0;i<N;i++) parts.push({ x: Math.random()*innerWidth, y: -20-Math.random()*200, vy: 2+Math.random()*4, vx: -1+Math.random()*2, w: 6+Math.random()*8, h: 8+Math.random()*12, rot: Math.random()*6, hue: Math.floor(Math.random()*360)});
      let t=0; (function loop(){ t++; ctx.clearRect(0,0,c.width,c.height); ctx.save(); ctx.scale(dpr,dpr);
        for(const p of parts){ p.y+=p.vy; p.x+=p.vx; p.rot+=0.12; ctx.translate(p.x,p.y); ctx.rotate(p.rot); ctx.fillStyle = `hsl(${p.hue}, 90%, 60%)`; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h); ctx.setTransform(1,0,0,1,0,0); }
        ctx.restore(); if(t<260) requestAnimationFrame(loop); else document.body.removeChild(layer);
      })();
      window.addEventListener('resize', resize, {once:true});
    }

    /* =======================
       Firebase Init
    ======================= */
    let app, analytics;
    try { app = initializeApp(firebaseConfig); try { analytics = getAnalytics(app); } catch {} }
    catch(e){ console.error('Firebase init error', e); showStatus('Errore init Firebase: ' + (e?.message||e)); }

    const auth = getAuth(app);
    const db   = getFirestore(app);

    const CONTEST_ID = 'ferragosto2025';
    const votesCol   = collection(db, `contests/${CONTEST_ID}/votes`);

    // Stato
    let currentUser = null;
    let votesCache  = [];
    let myVote      = null; // { entryId, chef: 'c1'|'c2' }
    let votingClosed = false;

    // Migrazione vecchia cache (safe)
    try { ['pizzaContest_votes_v1','pizzaContest_device_voted_v1'].forEach(k=> localStorage.removeItem(k)); } catch(e){}

    /* =======================
       Auth & Live
    ======================= */
    signInAnonymously(auth).catch(e=>{ console.error('Auth error', e); showStatus('Auth anonima fallita: ' + (e?.message||e)); });

    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      const dev = document.getElementById('deviceInfo');
      if (dev) dev.textContent = user ? `Utente: ${user.uid.slice(0,8)}‚Ä¶` : 'Stato: non autenticato';
      await fetchMyVote();
      initAdmin();
      subscribeVotes();
      renderAll();
    });

    async function fetchMyVote(){
      if(!currentUser) return;
      const snap = await getDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`));
      if (snap.exists()) {
        const d = snap.data();
        // retrocompat: se esiste "pizzaiolo" (nome), prova a mapparlo su c1/c2 della entry
        let chef = d.chef;
        if (!chef && d.pizzaiolo && d.entryId) {
          const entry = ENTRIES.find(e=>e.id===d.entryId);
          if (entry) chef = (d.pizzaiolo === entry.c2) ? 'c2' : 'c1';
        }
        myVote = { entryId: d.entryId || null, chef: chef === 'c2' ? 'c2' : 'c1' };
      } else {
        myVote = null;
      }
    }

    function subscribeVotes(){
      onSnapshot(votesCol, (snap) => {
        votesCache = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderResults();
        renderMeta();
      }, (e)=>{ console.error(e); showStatus('Errore lettura live: ' + (e?.message||e)); });
    }

    /* =======================
       Voto
    ======================= */
    async function vote(entryId, chef){
      if (votingClosed) { showStatus('‚õî Votazioni chiuse.', 'warning'); return; }
      if(!currentUser){ showStatus('Auth in corso, riprova‚Ä¶','warning'); return; }
      const changing = myVote && (myVote.entryId !== entryId || myVote.chef !== chef);
      try{
        await setDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`),
          { entryId, chef, ts: serverTimestamp(), ua: navigator.userAgent }, { merge: true });
        myVote = { entryId, chef };
        renderCards();
        confetti();
        showStatus(changing ? '‚úÖ Voto aggiornato!' : '‚úÖ Voto registrato!', 'success');
      }catch(e){
        console.error('Write error', e);
        if(String(e).includes('Missing or insufficient permissions')) showStatus('Regole Firestore: abilita UPDATE sul proprio doc.', 'warning');
        else showStatus('Scrittura voto fallita: ' + (e?.message||e));
      }
    }

    /* =======================
       Tally & Aggregazioni
    ======================= */
    function tallyCounts(){
      const counts = Object.fromEntries(ENTRIES.map(e=>[e.id,{c1:0,c2:0,total:0}]));
      for(const v of votesCache){
        if(!v.entryId || !counts[v.entryId]) continue;
        const entry = ENTRIES.find(e=> e.id === v.entryId);
        // mappa chef
        let ch = (v.chef==='c2'||v.chef==='c1') ? v.chef : 'c1';
        if (!v.chef && v.pizzaiolo && entry) ch = (v.pizzaiolo === entry.c2) ? 'c2' : 'c1';
        counts[v.entryId][ch]++;
        counts[v.entryId].total++;
      }
      return counts;
    }

    function chefsTotals(){
      const c = tallyCounts();
      let c1Total = 0, c2Total = 0;
      for (const k in c){ c1Total += c[k].c1; c2Total += c[k].c2; }
      // presumo stessi nomi su tutte le entry; se diverso, prendo quelli della prima
      const nameC1 = ENTRIES[0]?.c1 || 'C1';
      const nameC2 = ENTRIES[0]?.c2 || 'C2';
      return { c1Total, c2Total, nameC1, nameC2 };
    }

    /* =======================
       Render
    ======================= */
    function renderCards(){
      const wrap = document.getElementById('cards');
      const counts = tallyCounts();
      wrap.innerHTML='';
ENTRIES.forEach(entry => {
        const c = counts[entry.id] || {c1:0,c2:0,total:0};
        const col = document.createElement('div');
        col.className = 'col-12 col-sm-6 col-lg-3 position-relative';

        const mine = myVote && myVote.entryId === entry.id ? myVote.chef : null;
        const disabled = votingClosed ? 'disabled' : '';

        col.innerHTML = `
          <div class="dark-card pizza-card h-100">
            <div class="pizza-img"><img src="${entry.img}" alt="${entry.name}" loading="lazy"></div>
            ${mine ? '<div class="badge-mine"><i class="bi bi-heart-fill"></i> Il tuo voto</div>' : ''}
            <h5 class="mb-1">${entry.name}</h5>
            <p class="text-light small mb-2">${entry.desc || ''}</p>

            <div class="d-grid gap-2 my-2">
              <button class="vote-btn vote-c1 ${mine==='c1'?'active':''}" data-id="${entry.id}" data-chef="c1" ${disabled}>
                <i class="bi bi-hand-thumbs-up"></i> ${entry.c1}
              </button>
              <button class="vote-btn vote-c2 ${mine==='c2'?'active':''}" data-id="${entry.id}" data-chef="c2" ${disabled}>
                <i class="bi bi-hand-thumbs-up"></i> ${entry.c2}
              </button>
            </div>

            <div class="d-flex justify-content-between align-items-center mt-auto">
              <span class="pill"><i class="bi bi-people me-1"></i>${c.c1} ‚Ä¢ ${c.c2}</span>
              <span class="pill">Tot: <strong>${c.total}</strong></span>
            </div>
          </div>
        `;
        wrap.appendChild(col);
      });

      wrap.querySelectorAll('.vote-btn').forEach(btn => {
        btn.addEventListener('click', () => vote(btn.getAttribute('data-id'), btn.getAttribute('data-chef')));
      });
    }

    function renderChartChefs(t){
      const canvas = document.getElementById('resultsCanvas');
      if(!canvas) return;

      const ctx = canvas.getContext('2d');
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth;
      const height = canvas.clientHeight;
      canvas.width = width * dpr; canvas.height = height * dpr;
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.clearRect(0,0,width,height);

      const m = {l: 140, r: 28, t: 28, b: 40};
      const gap = 24;
      const n = 2;
      const barH = Math.max(28, Math.min(60, (height - m.t - m.b - gap*(n-1)) / n));
      const maxV = Math.max(1, t.c1Total, t.c2Total);
      const x = v => m.l + (v / maxV) * (width - m.l - m.r);

      // Testo leader
      const leaderMsg = t.c1Total === t.c2Total ? 'Parit√†' : (t.c1Total > t.c2Total ? `${t.nameC1} in vantaggio` : `${t.nameC2} in vantaggio`);
      ctx.font = '13px Poppins, sans-serif';
      ctx.fillStyle = '#e6f3ff';
      ctx.fillText(leaderMsg, m.l, 16);

      const rows = [
        {label: t.nameC1, value: t.c1Total, colors: ['#00D2FF','#2ED8B6']},
        {label: t.nameC2, value: t.c2Total, colors: ['#FF6B9D','#FFD93D']}
      ];

      rows.forEach((r,i)=>{
        const y = m.t + i * (barH + gap);
        // label a sinistra
        ctx.font = '16px Poppins, sans-serif';
        ctx.fillStyle = '#e6f3ff';
        const maxLabelW = m.l - 20;
        let text = r.label;
        while (ctx.measureText(text).width > maxLabelW && text.length>0) text = text.slice(0,-1);
        if (text !== r.label) text += '‚Ä¶';
        ctx.fillText(text, 12, y + barH/2);

        // background barra
        ctx.fillStyle = 'rgba(255,255,255,.12)';
        ctx.fillRect(m.l, y, width - m.l - m.r, barH);

        // barra
        const xe = x(r.value);
        const grad = ctx.createLinearGradient(m.l, y, xe, y);
        grad.addColorStop(0, r.colors[0]); grad.addColorStop(1, r.colors[1]);
        ctx.fillStyle = grad;
        ctx.fillRect(m.l, y, Math.max(2, xe - m.l), barH);

        // valore
        ctx.font = 'bold 14px Poppins, sans-serif';
        ctx.fillStyle = '#fff';
        ctx.fillText(String(r.value), xe + 8, y + barH/2);
      });
    }

    function renderResults(){
      renderCards();
      renderChartChefs(chefsTotals());
    }

    function renderMeta(){
      const total = votesCache.length;
      const el = document.getElementById('votesInfo');
      if (el) el.textContent = `Voti totali: ${total}`;
    }

    function renderAll(){
      renderCards();
      renderMeta();
      renderChartChefs(chefsTotals());
      window.addEventListener('resize', () => renderChartChefs(chefsTotals()));
    }

    /* =======================
       Admin
    ======================= */
    function initAdmin(){
      const params = new URLSearchParams(location.search);
      const isAdmin = params.get('admin') === '1';
      const box = document.getElementById('adminTools');
      if(isAdmin) box.classList.remove('d-none');

      const clearBtn = document.getElementById('btnClearLocal');
      if (clearBtn) clearBtn.addEventListener('click', () => {
        ['pizzaContest_votes_v1','pizzaContest_device_voted_v1'].forEach(k=> localStorage.removeItem(k));
        showStatus('Cache locale (vecchia versione) pulita. Ricarica la pagina.', 'success');
      });

      const testBtn = document.getElementById('btnTestWrite');
      if(testBtn) testBtn.addEventListener('click', async ()=>{
        if(!currentUser){ showStatus('Auth non pronta, riprova‚Ä¶', 'warning'); return; }
        try{
          await setDoc(doc(db, `contests/${CONTEST_ID}/votes/${currentUser.uid}`),
            { entryId: 'TEST', chef: 'c1', ts: serverTimestamp(), ua: 'admin-test' }, { merge: true });
          showStatus('‚úÖ Test write OK. Controlla Firestore.', 'success');
        } catch(e){ console.error(e); showStatus('‚ùå Test write fallita: ' + (e?.message||e)); }
      });

      const exCsv = document.getElementById('btnExportCsv');
      if(exCsv) exCsv.addEventListener('click', async ()=> exportVotes('csv'));

      const exJson = document.getElementById('btnExportJson');
      if(exJson) exJson.addEventListener('click', async ()=> exportVotes('json'));
    }

    async function exportVotes(kind='csv'){
      const rows = votesCache.map(v => [
        v.id, v.entryId || '', v.chef || (v.pizzaiolo || ''), (v.ts && v.ts.toDate ? v.ts.toDate().toISOString() : ''), v.ua || ''
      ]);
      if(kind==='json'){
        const blob = new Blob([JSON.stringify(rows.map(r=>({uid:r[0], entryId:r[1], chef:r[2], ts:r[3], ua:r[4]})), null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pizza_votes.json'; a.click();
      } else {
        const csv = [['uid','entryId','chef','timestamp','ua'], ...rows]
          .map(r=>r.map(x=>'"'+String(x).replaceAll('"','""')+'"').join(','))
          .join('\n');
        const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'pizza_votes.csv'; a.click();
      }
    }

    /* =======================
       Misc
    ======================= */
    // Navbar effetto
    window.addEventListener('scroll', () =>
      document.querySelector('.navbar').classList.toggle('scrolled', window.scrollY > 10)
    );

    // Countdown: blocca il voto alla scadenza (ora locale IT)
    const target = new Date('2025-08-15T23:59:59+02:00').getTime();
    function pad2(n){return String(n).padStart(2,'0')}
    function tick(){
      const now = Date.now();
      const d = target - now;
      const c = document.getElementById('countdown');
      if (d <= 0) {
        if (!votingClosed) { votingClosed = true; renderCards(); showStatus('‚õî Votazioni chiuse.', 'warning'); }
        c.innerHTML =
          '<div class="cd"><strong>00</strong><div>giorni</div></div>'+
          '<div class="cd"><strong>00</strong><div>ore</div></div>'+
          '<div class="cd"><strong>00</strong><div>min</div></div>'+
          '<div class="cd"><strong>00</strong><div>sec</div></div>';
        return;
      }
      const s = Math.floor(d/1000);
      const days = Math.floor(s/86400);
      const hrs  = Math.floor((s%86400)/3600);
      const mins = Math.floor((s%3600)/60);
      const secs = s%60;
      c.innerHTML =
        `<div class="cd"><strong>${days}</strong><div>giorni</div></div>`+
        `<div class="cd"><strong>${pad2(hrs)}</strong><div>ore</div></div>`+
        `<div class="cd"><strong>${pad2(mins)}</strong><div>min</div></div>`+
        `<div class="cd"><strong>${pad2(secs)}</strong><div>sec</div></div>`;
    }
    setInterval(tick, 1000); tick();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
